
## 概要
VPC構築

## 要件
- VPC
  - DNSホスト名：有効
  - DNS解決：有効（Auroraサーバレスの利用を見越した設定）
  - CIDRブロック「〜〜」
- public
  - 機能要件
    - 異なるAZで2サブネット用意
    - インターネット通信を許可
    - NATGWを配置（EC2のミドルウェア、ソフトウェアのため）   
    - ALBを配置予定
    - エフェメラルポートの許可
  - 非機能要件
    - NATGW利用終了後に停止（Cloudwatch起動時に一時的に再開）
- private
  - 機能要件
    - 異なるAZで2サブネット用意
    - アプリサーバ（EC2）、DBサーバ（Auroraサーバレス）を配置予定
    - パブリックサブネットとの相互通信のみ許可
    - DBサブネットグループを作成
  - 非機能要件
    - なし

## 手順
- VPC作成
  - VPCをCIDRブロック「10.0.0.0/16」で作成。作成時以下を設定
    - DNSホスト名：有効
    - DNS解決：有効
- サブネット作成
  - パブリック用サブネット「wp-public-1a-sn」（10.0.1.0/24）、「wp-public-1c」（10.0.2.0/24）を作成。
  - プライベート用サブネット「wp-private-1a-sn」（10.0.11.0/24）、「wp-private-1c」（10.0.12.0/24）を作成
- インターネットゲートウェイ作成
  - インターネットゲートウェイを作成
  - VPCにアタッチ
- Natゲートウェイを作成
  - EIPを取得
  - NATGWを作成
  - サブネット「wp-public-1a sn」にアタッチ
- ルートテーブル作成
  - パブリック用ルートテーブル「wp-public-rt」を作成。0.0.0.0をINGWへルーティング。
  - サブネット「wp-public-1a-sn」「wp-public-1c-sn」に関連づける
  - プライベート用ルートテーブル「wp-private-rt」を作成。0.0.0.0をNATGWへルーティング。
  - サブネット「wp-private-1a-sn」「wp-private-1c-sn」に関連づける
  - ※NATGWの設定削除。（常時稼働を想定して設定したが、本環境ではコスト削減のためNATGWは利用時に随時設定する運用とする）
    - 一旦NATGW削除しEIPを解放する
    - ルートテーブルからNATGWへのルーティングを削除する
- セキュリティグループ作成
  - ALB用セキュリティグループ「wp-alb-sg」を作成する
  - Webアプリ用セキュリティグループ「wp-webapp-sg」を作成する
  - DB用セキュリティグループ「wp-db-sg」を作成する
- DBサブネットグループ作成
  - サブネット「wp-private-1a-sn」「wp-private-1c-sn」を含んだDBサブネットグループを作成する

## 実施後と比較して
- 選択するリージョンとAZも明記しておくとよかった
- VPCやINGW、NATGWの名前も決めておくとよかった
- 2025/11リリースのNATGWの新機能「アベイラビリティーモード：リージョナル」により、特定のパブリックサブネットにアタッチせず、VPC内のAZにまたがったNATGWを作成できるようになっていた。これによりEIPの解放作業も不要になっていた。特定のパブリックサブネットにアタッチするよりも可用性を向上できるため今後もリージョナルを選択する方針とした。以下手順が不要となった。
  - EIPを取得
  - サブネット「wp-public-1a sn」にアタッチ
- DBサブネットグループ作成の手順の粒度が荒かった。RDS>サブネットグループで作成へと進む。

## 対応ナレッジ
- セキュリティグループでエフェメラルポートの許可
- DNS設定をしないとIPが変わるようなサービスとの連携ができない
- Auroraの作成場所としてDBサブネットグループが必要
- Auroraの作成には2つ以上の異なるAZのサブネットが必要
- セキュリティグループの設定はEC2やAurora作成時に実施
- INGWのアタッチ先はVPC
- リソースの命名規則は[プロジェクト名]-[識別名]-[リソースタイプ]とした
- 伝播...VPCと接続している外部ネットワークでPIPの追加、変更がされた場合自動で検知し（BGPというプロトコル）、ルートテーブルに動的にルーティング設定してくれる機能
