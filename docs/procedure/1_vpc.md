# VPC 構築手順

## 概要
VPC を構築する。

## 要件
### VPC
- **DNSホスト名**: 有効
- **DNS解決**: 有効（Auroraサーバレスの利用を見越した設定）
- **CIDRブロック**: `10.0.0.0/16`

### パブリックサブネット
- **機能要件**:
  - 異なる AZ で2サブネット用意
  - インターネット通信を許可
  - NAT ゲートウェイを配置（EC2 のミドルウェアインストールのため）
  - ALB を配置予定
  - エフェメラルポートの許可
- **非機能要件**:
  - NAT ゲートウェイは利用終了後に停止（CloudWatch 起動時に一時的に再開）

### プライベートサブネット
- **機能要件**:
  - 異なる AZ で2サブネット用意
  - アプリサーバ (EC2)、DBサーバ (Auroraサーバレス) を配置予定
  - パブリックサブネットとの相互通信のみ許可
  - DBサブネットグループを作成
- **非機能要件**:
  - なし

## 手順

### 1. VPC 作成
以下の設定で VPC を作成する。

| パラメータ | 設定値 | 備考 |
| :--- | :--- | :--- |
| **IPv4 CIDR** | `10.0.0.0/16` | |
| **DNSホスト名** | 有効 | |
| **DNS解決** | 有効 | |

### 2. サブネット作成
以下の4つのサブネットを作成する。

| 用途 | サブネット名 | CIDR | AZ (想定) |
| :--- | :--- | :--- | :--- |
| **パブリック** | `wp-public-1a-sn` | `10.0.1.0/24` | ap-northeast-1a |
| **パブリック** | `wp-public-1c-sn` | `10.0.2.0/24` | ap-northeast-1c |
| **プライベート** | `wp-private-1a-sn` | `10.0.11.0/24` | ap-northeast-1a |
| **プライベート** | `wp-private-1c-sn` | `10.0.12.0/24` | ap-northeast-1c |

### 3. インターネットゲートウェイ (IGW) 作成
1. インターネットゲートウェイを作成する。
2. 作成した IGW を VPC にアタッチする。

### 4. NAT ゲートウェイ (NATGW) 作成
1. EIP (Elastic IP) を取得する。
2. NATGW を作成し、サブネット `wp-public-1a-sn` にアタッチする。

### 5. ルートテーブル作成
各ルートテーブルを作成し、ルーティングとサブネットの関連付けを行う。

| ルートテーブル名 | ターゲット (0.0.0.0/0) | 関連付けサブネット |
| :--- | :--- | :--- |
| **wp-public-rt** | インターネットゲートウェイ (IGW) | `wp-public-1a-sn`<br>`wp-public-1c-sn` |
| **wp-private-rt** | NAT ゲートウェイ (NATGW) | `wp-private-1a-sn`<br>`wp-private-1c-sn` |

### 6. NAT ゲートウェイの設定削除（コスト削減対応）
> **Note:** 常時稼働を想定して設定したが、本環境ではコスト削減のため NATGW は利用時に随時設定する運用とする。

1. 作成した NATGW を削除し、EIP を解放する。
2. ルートテーブル (`wp-private-rt`) から NATGW へのルーティングを削除する。

### 7. セキュリティグループ作成
枠のみ作成する（ルールはリソース作成時に設定）。

- ALB用: `wp-alb-sg`
- Webアプリ用: `wp-webapp-sg`
- DB用: `wp-db-sg`

### 8. DBサブネットグループ作成
- サブネット `wp-private-1a-sn`, `wp-private-1c-sn` を含んだ DBサブネットグループを作成する。

---

## 実施後と比較して（技術メモ）
- 選択するリージョンと AZ も明記しておくとよかった。
- VPC や IGW、NATGW の名前も事前に決めておくとよかった。
- **NATGW の新機能**: 2025/11リリースの「アベイラビリティーモード：リージョナル」により、特定のパブリックサブネットにアタッチせず、VPC 内の AZ にまたがった NATGW を作成可能になった。これにより EIP の解放作業も不要となり、可用性も向上するため、今後はリージョナルを選択する方針とする。（上記手順の「EIP取得」「特定サブネットへのアタッチ」は不要となる）
- **DBサブネットグループ**: 作成手順の粒度が荒かった。「RDS > サブネットグループ」から作成へ進む。
