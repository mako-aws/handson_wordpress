# EC2 構築・WordPress 導入手順

## 概要
EC2 を起動し、WordPress を稼働させる。
- EC2 起動
- セキュリティグループ設定
- Apache インストール
- PHP と周辺モジュールインストール
- WordPress ダウンロード

## 要件
### EC2
- **非機能要件**:
  - レスポンス速度を要件としない。
  - WordPress 稼働に必要なストレージのみでよい。
  - 接続元 IP アドレスが変動するため、セキュリティグループで SSH 接続を許可する IP アドレスを固定したくない。SSM 接続する運用とする。

## 手順

### 1. SSM 接続準備 (IAMロール)
以下の IAM ロールを作成する。
- **ロール名**: `wp-for_ec2_ssm-role`
- **対象サービス**: EC2
- **許可ポリシー**: `AmazonSSMManagedInstanceCore`

### 2. EC2 起動
以下のパラメータでインスタンスを作成する。

| カテゴリ | パラメータ | 設定値 |
| :--- | :--- | :--- |
| **基本設定** | 名前 | `wp-1a-ec2` |
| | AMI | Amazon Linux 2023 kernel-6.1 AMI |
| | アーキテクチャ | x86_64 |
| | インスタンスタイプ | `t3.micro` |
| | キーペア | なし (作成予定だった `wp-ec2-key` は不要とした) |
| **ネットワーク** | VPC | `wp` |
| | サブネット | `wp-private-1a-sn` |
| | パブリックIP自動割当 | **有効** |
| | セキュリティグループ | 新規作成: `wp-ec2-sg` |
| | SGインバウンド | HTTP許可<br>※SSH(0.0.0.0/0)はALB作成時に設定するためチェックを外す |
| **ストレージ** | サイズ / タイプ | `20 GiB` / `gp3` |
| **高度な設定** | IAMプロファイル | `wp-for_ec2_ssm-role` |

### 3. WordPress 起動設定
作成した EC2 に SSM 接続し、以下のコマンドを順次実行する。

```bash
# --- 1. システム更新とミドルウェア導入 ---
# ルートユーザにスイッチ
sudo su -

# パッケージの更新
sudo dnf update -y

# Apache、PHP、および必要な拡張ライブラリを一括インストール
sudo dnf install -y httpd php php-mysqlnd php-gd php-xml php-mbstring php-intl

# --- 2. サービスの起動設定 ---
# PHP-FPMの起動と自動起動設定
sudo systemctl start php-fpm
sudo systemctl enable php-fpm

# Apacheの起動と自動起動設定
sudo systemctl start httpd
sudo systemctl enable httpd

# 状態確認（Active: active (running) と出ればOK）
sudo systemctl status httpd

# --- 3. WordPress の配置 ---
# テンポラリディレクトリへ移動
cd /tmp

# 最新版のダウンロードと解凍
wget [https://wordpress.org/latest.tar.gz](https://wordpress.org/latest.tar.gz)
tar -xzf latest.tar.gz

# Apacheのドキュメントルート（公開場所）へコピー
sudo cp -r wordpress/* /var/www/html/

# --- 4. 権限設定とDBクライアント ---
# 所有者をapacheユーザーに変更
sudo chown -R apache:apache /var/www/html/

# 書き込み権限の調整
sudo chmod -R 755 /var/www/html/

# MySQLクライアントのインストール (接続確認用)
sudo dnf install -y mariadb105

```

## 実施後と比較して（技術メモ）
- **SSM接続の採用**: 当初はEC2にSSH接続することを想定していたが、接続元IPアドレスが固定でないため変更都度設定を変える必要があった。SSM接続を利用することで固定の接続元IPアドレスに依存せず接続が可能となった。
- **インスタンスタイプの選定**: インスタンスタイプはt3.microとしたがt4g.microと迷った。wordpressはarmタイプのCPUでも動作が担保されており、かつコストメリットもあったが初回ということもありより実績のあるt3.microを選定した。
- **トラブルシューティング**: 完成した！と思いさっそくブラウザからアクセスしてみたら不明なIPとの表示が。。なぜと思いよくみてみたらプライベートIPアドレスを利用していた。とほほ、、ではあったが無事インストールまで完了できてよかった。
- **ドキュメント作成**: この辺りからmarkdown方式のドキュメントの書き方を少しずつ覚えてきた。
- **サブネット設定の修正**: 後々気づいたが、VPCとサブネットを選択できていなかった。間違ったサブネットで作成済みのEC2のAMIを、正しいサブネットで使用しコピーを作成しすることで、実質的なサブネット変更の処理をした。


