## 概要
DBサーバとしてRDS for MySQLを起動。
※当初はAurora Serverlessを利用予定だったが無料利用枠がなかったためRDSを利用するように計画変更した。


## 要件

## 手順作成
- RDS用セキュリティグループを作成
  - セキュリティグループ名：「wp-rds-sg」
  - VPC：「wp」
  - インバウンドルール
    - タイプ：カスタムTCP
    - ポート範囲：3306
    - リソースタイプ：カスタム
    - ソース：「wp-ec2-sg」
  - アウトバウンドルールは変更なし（フルオープン）
- RDS for MySQLを起動（フル設定）
  - エンジンのオプション：MySQL
  - エンジンバージョン：MySQL 8.0.43（最新）
  - テンプレート：無料利用枠
  - 可用性と耐久性：シングルAZ
  - DBインスタンス識別子：「wp-1a-rds」
  - マスターユーザー名：「wp_1a_rds_master」
    - 認証情報管理：セルフマネージド
    - パスワードを自動作成にチェック
  - インスタンスクラス：db.t4g.micro
  - ストレージタイプ:gp3
  - ストレージ割り当て：20
  - コンピューティングリソース：EC2コンピューティングリソースに接続しない
  - ネットワークタイプ：IPv4
  - VPC：「wp」
  - DBサブネットグループ：「wp-dbsng」
  - セキュリティグループ：「wp-rds-sg」
  - AZ：ap-northeast-1a
  - RDS Proxyはチェックなし
  - 認証情報：デフォルト
  - データベースポート：3306
  - データベース認証：パスワードとIAMデータベース認証
  - 拡張モニタリング：有効　OSメトリクスの詳細度：60秒
  - ログのエクスポート：エラーログ、スロークエリログ
  - 最初のデータベース名：wordpress
  - DBパラメータグループ：default.mysql8.0
  - オプショングループ：default:mysql-8-0
  - 自動バックアップ：有効
  - バックアップ保持期間：1日間
  - バックアップウィンドウ：指定　18:00 0.5時間
  - バックアップタグ：なし
  - バックアップレプリケーション：なし
  - 暗号を有効化：有効
  - マイナーバージョンの自動アップグレード：有効
  - メンテナンスウィンドウ：指定　19:00 0.5時間
  - 削除保護の有効化：有効


## 実施後と比較して
  - 用意した手順でハンズオンしたのち、手順通りに進まなかった点をピックアップ
  - トラブルシューティングをまとめる

## 対応ナレッジ
- マスタユーザ：ミドルウェア上（RDMS）の管理ユーザ
- EC2用ユーザを作成して認証情報をSecret Managerで管理するよう設定変更&EC2側のconfigファイル修正もやりたい
- DBインスタンスクラスは「db.tb4.micro」を選択した。armベースのプロセッサはAWS自社開発のため価格が安く処理が早いメリットがあるが一部のミドルウェアとの互換性が担保されていない場合があるというデメリットがあった。しかしDBの場合はミドルウェアであるRDMS(今回はMySQL）をマネージドサービスとして提供されているため、ミドルウェアとの互換性はAWS側で担保されている。よってデメリットを考慮する必要がないため「db.tb4.micro」を選択してよしとした。
- RDS Proxyはコネクションが増加する見込みはないため不要とした。今後拡張版としてリリースしたい
- 認証情報はSSL通信を行うということではなく、もしSSLを使うならどのCAの証明書を使う？という設定。RDSはSSLの利用有無にかかわらず証明書が発行される。
- データベース認証はIAM認証が望ましいがスクリプトの修正が必要になるため一旦はパスワード認証を利用する。のちにIAM認証に移行したい。
- DBパラメータグループ：MySQLなどのミドルウェア（RDMS）のデフォルトの環境設定（タイムゾーン、文字コードなど）の設定ファイル。AWS側が提供している
- オプショングループ：拡張機能の設定ファイル。デフォルトは何も入っていない。
- セキュリティグループのソースはEC2用などのセキュリティグループを指定することで都度接続元を追加する必要はない
- 拡張モニタリングはOS上のプロセス単位でのモニタリングが可能（ソフト寄り）。一方標準モニタリングはハイパーバイザー上のCPU使用率などのメトリクスのみモニタリングが可能（ハード寄り）。本番運用では拡張モニタリングなしではモニタリングとして不十分だが、開発環境など再起動が可能な状況であればコスト削減を目的として標準モニタリングのみにするケースもある。
- ログのエクスポートを利用することで、RDSのディスク内に保存されているログを管理画面からダウンロードしてみる手間を省き、cloudwatcｈ logに格納することができる。これをしないとログは自動でローテーションされ消えてしまうため、保存も目的でも利用する必要がある。また、cloud watchに吐き出すことで一定のイベント時（errorなど）にイベントトリガーとしてメールを送信、などに利用することもできる
- RDSはマネージドサービスのためSSH接続できない。よって3306ポートでの接続を許可しているアプリサーバ（EC2）からSQLベースで操作をする。それがない場合は踏み台（EC2）を用意して同様に接続する方法などがある。
