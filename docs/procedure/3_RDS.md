# RDS (MySQL) 構築手順

## 概要
DBサーバとして RDS for MySQL を構築する。
当初は Aurora Serverless を検討したが、無料利用枠の適用範囲を考慮し、RDS (Single-AZ) を採用する。

## 手順

### 1. RDS用セキュリティグループ作成
以下の設定でセキュリティグループを作成する。

| パラメータ | 設定値 | 備考 |
| :--- | :--- | :--- |
| **セキュリティグループ名** | `wp-rds-sg` | |
| **VPC** | `wp` | |
| **インバウンドルール** | ポート: `3306`<br>ソース: `wp-ec2-sg` | EC2 からのアクセスのみ許可 |
| **アウトバウンドルール** | 全許可 (デフォルト) | |

### 2. RDS for MySQL 起動
コンソールの「データベースの作成」より、以下のパラメータを設定する。

#### ① エンジン・インスタンス設定
| カテゴリ | パラメータ | 設定値 |
| :--- | :--- | :--- |
| **エンジンのオプション** | エンジンのタイプ | **MySQL** |
| | エンジンバージョン | **MySQL 8.0.43** (最新) |
| | テンプレート | **無料利用枠** |
| **可用性と耐久性** | デプロイオプション | シングル DB インスタンス (Single-AZ) |
| **設定** | DB インスタンス識別子 | `wp-1a-rds` |
| | マスターユーザー名 | `wp_1a_rds_master` |
| | 認証情報管理 | セルフマネージド |
| | マスターパスワード | 自動生成 (チェックを入れる) |
| **インスタンス設定** | DB インスタンスクラス | `db.t4g.micro` (ARMベース) |
| **ストレージ** | ストレージタイプ | `gp3` |
| | ストレージ割り当て | `20 GiB` |

#### ② 接続・ネットワーク設定
| カテゴリ | パラメータ | 設定値 |
| :--- | :--- | :--- |
| **接続** | コンピューティングリソース | EC2 コンピューティングリソースに接続しない |
| | ネットワークタイプ | IPv4 |
| | VPC | `wp` |
| | DB サブネットグループ | `wp-dbsng` |
| | パブリックアクセス | **なし** |
| | VPC セキュリティグループ | 既存の選択: `wp-rds-sg` |
| | アベイラビリティーゾーン | `ap-northeast-1a` |
| | RDS Proxy | チェックなし |
| | 認証局 (CA) | デフォルト (rds-ca-2019 等) |
| | データベースポート | `3306` |
| **データベース認証** | 認証オプション | **パスワードと IAM データベース認証**<br>(※IAM認証も有効化) |

#### ③ モニタリング・追加設定
| カテゴリ | パラメータ | 設定値 |
| :--- | :--- | :--- |
| **モニタリング** | 拡張モニタリング | **有効** (詳細度: 60秒) |
| **追加設定** | 最初のデータベース名 | `wordpress` |
| | DB パラメータグループ | `default.mysql8.0` |
| | オプショングループ | `default:mysql-8-0` |
| **バックアップ** | 自動バックアップ | **有効** |
| | 保持期間 | 1日間 |
| | バックアップウィンドウ | 指定: `18:00` (UTC) から `0.5` 時間 |
| | レプリケーション / タグ | なし |
| **暗号化** | 暗号化の有効化 | **有効** (デフォルトキー) |
| **メンテナンス** | マイナーVer自動アップグレード | **有効** |
| | メンテナンスウィンドウ | 指定: `19:00` (UTC) から `0.5` 時間 |
| | ログのエクスポート | **エラーログ、スロークエリログ** (チェックを入れる) |
| **削除保護** | 削除保護の有効化 | **有効** |

---

## 技術メモ・振り返り

### 設計判断
- **インスタンスクラスの選定**: `db.t4g.micro` (ARMベース) を採用。RDMS (MySQL) は AWS 側で互換性が担保されているため、プロセッサアーキテクチャの違いによるアプリ側の非互換リスク（EC2の場合のような）を考慮する必要がなく、コストパフォーマンスが良い。
- **モニタリング**: 本番運用を見据え、OS レベルのメトリクスが取得できる「拡張モニタリング」を有効化した（標準モニタリングはハイパーバイザー層のみ）。
- **ログ管理**: ログの自動ローテーションによる消失を防ぐため、CloudWatch Logs へのエクスポート設定（エラーログ、スロークエリログ）を行った。これによりアラート通知などのイベントトリガーとしても利用可能となる。

### 用語・設定の補足
- **マスタユーザ**: RDMS 上の最高権限を持つ管理ユーザ。
- **RDS Proxy**: コネクションプーリング機能。今回は接続数の急増が見込まれないため利用しない。
- **DBパラメータグループ**: タイムゾーンや文字コードなど、DBエンジンの設定ファイル。
- **オプショングループ**: RDS の拡張機能設定ファイル。
- **認証情報の管理**: 今回はパスワード認証と IAM 認証を併用設定とした。将来的には EC2 側の設定を変更し、IAM 認証へ完全移行するか、Secrets Manager を導入してパスワード管理を自動化したい。
