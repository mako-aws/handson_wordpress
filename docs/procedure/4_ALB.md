# ALB (Application Load Balancer) 構築手順

## 概要
ALB を設定する。現時点では EC2 一台のみをターゲットとして設定する。

## 手順

### 1. ターゲットグループ作成
以下の設定でターゲットグループを作成する。

| パラメータ | 設定値 | 備考 |
| :--- | :--- | :--- |
| **ターゲットの種類** | インスタンス | |
| **ターゲットグループ名** | `wp-ec2-tg` | |
| **プロトコル / ポート** | HTTP / 80 | |
| **IPアドレスタイプ** | IPv4 | |
| **VPC** | `wp` | |
| **プロトコルバージョン** | HTTP1 | |
| **ヘルスチェック** | 変更なし | デフォルト設定を利用 |
| **ターゲットオプティマイザー** | なし | |

### 2. ALB用セキュリティグループ作成
以下の設定でセキュリティグループを作成する。

| パラメータ | 設定値 | 備考 |
| :--- | :--- | :--- |
| **セキュリティグループ名** | `wp-alb-sg` | |
| **VPC** | `wp` | |
| **インバウンドルール** | ポート: `80`<br>ソース: `0.0.0.0/0` | Anywhere IPv4 (Web公開用) |
| **アウトバウンドルール** | 全許可 | デフォルト |

### 3. ALB 作成
以下の設定でロードバランサーを作成する。

| カテゴリ | パラメータ | 設定値 |
| :--- | :--- | :--- |
| **基本設定** | ロードバランサータイプ | **ALB** (Application Load Balancer) |
| | ロードバランサー名 | `wp-alb` |
| | スキーム | インターネット向け |
| | IPアドレスタイプ | IPv4 |
| **ネットワーク** | VPC | `wp` |
| | IPプール | なし (AWS管理のIP) |
| | AZとサブネット | `wp-public-1a-sn`<br>`wp-public-1c-sn` |
| | セキュリティグループ | `wp-alb-sg` |
| **リスナーとルーティング** | プロトコル / ポート | HTTP / 80 |
| | アクション | ターゲットグループへ転送 |
| | ターゲットグループ | `wp-ec2-tg` |
| **属性設定** | ターゲットグループの維持<br>(スティッキーセッション) | **有効**<br>期間: 1時間 |

### 4. WordPress 初期設定
ブラウザから ALB の DNS 名にアクセスし、インストール画面で以下を入力する。

| パラメータ | 設定値 | 備考 |
| :--- | :--- | :--- |
| **Database Name** | `wordpress` | |
| **User Name** | `wp_1a_rds_master` | |
| **Password** | `<RDS作成時に設定したパスワード>` | ※セキュリティのため伏字 (元値: `IpUQ...`) |
| **Database Host** | `wp-1a-rds.cdq2sc0sow5f.ap-northeast-1.rds.amazonaws.com` | RDSのエンドポイント |
| **Table Prefix** | `wp_` | |

---

## 実施後と比較して（技術メモ・ナレッジ）
- **ALB の実体**: ALB はグループのような振る舞いをする。ALB を一つ作成すると、実際には2つ以上のサブネットに複数作成される（ネットワークマッピング）。
- **エンドポイント**: 固定 IP は存在しない（ユーザ側は IP を意識しない）。ALB 作成時に FQDN が発行されるので、それをエンドポイントとして利用できる。
- **セキュリティ**: ALB はトラフィックの通過点であるため、ALB 自体にもセキュリティグループの設定が必要である。HTTP もしくは HTTPS しか受け付けないように設定すれば、不正な通信を遮断できる。
- **RDS の冗長化**: RDS はスタンバイ機を作成すると無料枠の対象から外れるため、今回は冗長構成を断念した。
- **HTTP プロトコル**: HTTP は従来の HTTP1 を利用する。高速な HTTP2 もあるが、WordPress が対応していない可能性があるため今回は利用しない。
- **ターゲットオプティマイザー**: アクセス数の上限を決める機能。上限以上は 503 エラーになる。高負荷処理が必要なワークロードにおいて、過負荷になることを回避するためのオプションである。
- **IPAM (IP Address Manager)**: IP の重複を防止する機能。オンプレミスで使っているレンジ帯の IP アドレスを ALB に付与したい時などに使う。IPAM プールの ID を入れると自動で割り当ててくれる。
- **ターゲットグループの維持**: スティッキーセッションの機能。有効にするのが無難である。セッション中は他のターゲットグループ（サーバ）にルーティングされないよう、Cookie にルーティングしたサーバの情報を書き込む。次にこのクライアントからリクエストが来た時は Cookie の情報を読んで同じサーバにルーティングする仕組みである。
